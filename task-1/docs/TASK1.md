# Архитектура системы e-commerce

Практическое задание № 1 - проектирование архитектуры программной системы для предметной области электронной коммерции.

Цель: спроектировать архитектуру маркетплейса по типу AliExpress, Ozon или Wildberries, но без собственной службы доставки - для этой функции используются внешние провайдеры.

---

## Оглавление

1. [Предметная область](#1-предметная-область)
2. [Архитектурный контекст (C4 Level 1)](#2-архитектурный-контекст-c4-level-1)
3. [Контейнеры системы (C4 Level 2)](#3-контейнеры-системы-c4-level-2)
4. [Компоненты системы (C4 Level 3)](#4-компоненты-системы-c4-level-3)
5. [Sequence Diagrams](#5-sequence-diagrams)
6. [Архитектурный стиль и решения](#6-архитектурный-стиль-и-решения)
7. [Функциональные требования](#7-функциональные-требования)
8. [Нефункциональные требования](#8-нефункциональные-требования)

---

## 1. Предметная область

### 1.1. Бизнес-контекст

Система представляет собой маркетплейс B2C с поддержкой множества продавцов. Платформа объединяет покупателей и продавцов, предоставляя инструменты для торговли, но не владеет собственной логистикой - эта функция делегируется внешним провайдерам. Для продавцов предусмотрена верификация юридических реквизитов через API ФНС.

### 1.2. Доменная модель

| Сущность | Описание | Ключевые атрибуты |
|----------|----------|-------------------|
| Товар | Единица продажи в каталоге | ID, цена, описание, остаток, категория, продавец |
| Покупатель | Пользователь-клиент | ID, контакты (телефон, email), адреса доставки, история заказов |
| Продавец | Пользователь-бизнес | ID, контакты, реквизиты, статус верификации, разрешённые службы доставки |
| Заказ | Зафиксированная сделка | ID, позиции (снимок товаров), жизненный цикл статусов (см. ниже), способ оплаты, служба доставки (из разрешённых продавцом), адрес |
| Корзина | Временный набор товаров | ID пользователя, список {товар, количество}, TTL |
| Каталог | Агрегат товаров | Иерархия категорий, индексы для поиска и фильтрации |

### 1.3. Роли и возможности

| Роль | Возможности |
|------|-------------|
| Клиент | Просмотр каталога, поиск, корзина, оформление заказа (выбор службы доставки из разрешённых продавцом), оплата, отслеживание доставки, получение уведомлений |
| Продавец | Регистрация с юр. реквизитами, верификация через ФНС, настройка разрешённых служб доставки, управление товарами и ценами, подтверждение заказов, передача отправления в службу доставки, аналитика продаж |

### 1.4. Способы аутентификации

- Логин/пароль
- OAuth (Google, VK, Яндекс и др.)
- Вход по телефону (SMS-код)
- Вход по email (код или magic link)

### 1.5. Жизненный цикл заказа и статусы

| Статус | Описание | Кто переводит |
|--------|----------|----------------|
| AWAITING_PAYMENT | Заказ создан, ожидается оплата от клиента | Система |
| PAID | Оплата прошла, заказ ждёт проверки продавцом | Система |
| PROCESSING | Продавец подтвердил заказ, готовит к отправке | Продавец |
| READY_TO_SHIP | Продавец оформил отправление, получил этикетку и трек-номер | Продавец |
| SHIPPING | Служба доставки приняла посылку, в пути | Система (webhook от СД) |
| DELIVERED | Доставлено получателю | Система (webhook от СД) |
| COMPLETED | Покупатель подтвердил получение | Покупатель / Система (авто) |
| CANCELLED | Заказ отменён на любом этапе | Покупатель / Продавец / Система |

### 1.6. Процесс передачи заказа в доставку

Процесс организован по модели маркетплейсов (AliExpress, Ozon):

Шаг 1. Подтверждение заказа (PAID -> PROCESSING)

- Продавец видит новый оплаченный заказ в личном кабинете
- Проверяет наличие товара и подтверждает заказ
- Начинает сборку и упаковку

Шаг 2. Оформление отправления (PROCESSING -> READY_TO_SHIP)

- Продавец нажимает «Оформить отправление» в личном кабинете
- Система создаёт заявку в службе доставки (выбранной покупателем из разрешённых)
- Служба доставки возвращает трек-номер и данные для этикетки
- Продавец печатает этикетку и наклеивает на посылку
- Статус меняется на READY_TO_SHIP - покупатель видит трек-номер

Шаг 3. Передача в службу доставки (READY_TO_SHIP -> SHIPPING)

- Продавец относит посылку в пункт приёма службы доставки
- Служба доставки сканирует посылку при приёмке
- Webhook от СД уведомляет систему -> статус автоматически меняется на SHIPPING
- Продавцу не нужно вручную отмечать передачу - это делает СД

Шаг 4. Доставка и завершение (SHIPPING -> DELIVERED -> COMPLETED)

- Служба доставки обновляет статус по мере движения посылки (webhooks)
- При вручении получателю -> DELIVERED
- Покупатель подтверждает получение -> COMPLETED
- Если покупатель не подтвердил за N дней - автоматический перевод в COMPLETED

Отмена заказа (-> CANCELLED)

- До отправки: покупатель или продавец могут отменить
- После отправки: только через процедуру возврата

---

## 2. Архитектурный контекст (C4 Level 1)

### 2.1. Назначение системы

Маркетплейс для розничной торговли: клиенты ищут товары, оформляют заказы, оплачивают и отслеживают доставку; продавцы управляют ассортиментом, ценами и анализируют продажи.

### 2.2. Границы системы

| Внутри системы | Вне системы |
|----------------|-------------|
| Web-приложение | Пользователи (клиенты, продавцы) |
| Backend API | Платёжные провайдеры |
| Доменные модули | Службы доставки |
| Хранилища данных | Email/SMS-провайдеры |
| | OAuth-провайдеры |
| | API ФНС |

### 2.3. Внешние системы и интеграции

| Внешняя система | Протокол | Назначение | Направление |
|-----------------|----------|------------|-------------|
| Платёжный провайдер | REST API + Webhooks | Приём платежей, возвраты | Исходящий + входящий (callback) |
| Сервис доставки | REST API + Webhooks | Создание отправлений, трекинг статусов | Исходящий + входящий (callback) |
| Email-провайдер | REST API | Отправка писем (коды, уведомления) | Исходящий |
| SMS-провайдер | REST API | Отправка SMS (коды, уведомления) | Исходящий |
| OAuth-провайдеры | OAuth 2.0 | Социальный вход | Исходящий |
| API ФНС | REST API | Верификация юр. реквизитов продавцов | Исходящий |

### 2.4. Диаграмма системного контекста (C4)

```mermaid
flowchart TB
    subgraph users ["Пользователи"]
        Client["Клиент<br/><i>Покупает товары</i>"]
        Seller["Продавец<br/><i>Управляет товарами</i>"]
    end

    System["E-commerce Platform<br/><i>Маркетплейс для розничной торговли</i>"]

    subgraph external ["Внешние системы"]
        Payment["Платёжный провайдер"]
        Delivery["Сервис доставки"]
        Email["Email-провайдер"]
        SMS["SMS-провайдер"]
        OAuth["OAuth-провайдеры"]
        FNS["API ФНС"]
    end

    Client -->|"Просмотр, заказы,<br/>оплата, отслеживание"| System
    Seller -->|"Управление товарами,<br/>заказы, аналитика"| System

    System -->|"Проведение платежей"| Payment
    System -->|"Создание доставок,<br/>получение статусов"| Delivery
    System -->|"Отправка писем"| Email
    System -->|"Отправка SMS"| SMS
    System -->|"Аутентификация"| OAuth
    System -->|"Верификация продавцов"| FNS

    Payment -.->|"Webhooks:<br/>статус платежа"| System
    Delivery -.->|"Webhooks:<br/>статус доставки"| System
```

### 2.5. Диаграмма вариантов использования (Use Case)

```mermaid
flowchart LR
    subgraph actors ["Акторы"]
        K((Клиент))
        P((Продавец))
    end

    subgraph external ["Внешние системы"]
        Pay[Платёжный провайдер]
        Del[Сервис доставки]
        Mail[Email-провайдер]
        SMS[SMS-провайдер]
        OAuth[OAuth-провайдеры]
        FNS[API ФНС]
    end

    subgraph system ["E-commerce система"]
        direction TB
        UC0a(Регистрация)
        UC0b(Вход в систему)
        UC1(Просмотр каталога)
        UC2(Поиск товаров)
        UC3(Оформление заказа)
        UC4(Оплата)
        UC5(Управление доставкой)
        UC6(Отслеживание статуса заказа)
        UC7(Уведомления о статусе)
        UC8(Размещение товара)
        UC9(Изменение цены)
        UC10(Просмотр аналитики)
        UC11(Верификация продавца)
        UC12(Подтверждение заказа)
        UC13(Передача отправления в СД)
    end

    K --> UC0a
    K --> UC0b
    K --> UC1
    K --> UC2
    K --> UC3
    K --> UC4
    K --> UC5
    K --> UC6
    K --> UC7
    P --> UC0a
    P --> UC0b
    P --> UC8
    P --> UC9
    P --> UC10
    P --> UC11
    P --> UC12
    P --> UC13
    UC0b -.->|OAuth| OAuth
    UC4 -.->|проведение| Pay
    UC5 -.->|интеграция| Del
    UC11 -.->|проверка реквизитов| FNS
    UC13 -.->|создание отправления| Del
    UC7 -.->|email| Mail
    UC7 -.->|SMS| SMS
```

---

## 3. Контейнеры системы (C4 Level 2)

### 3.1. Диаграмма контейнеров

```mermaid
flowchart TB
    subgraph users ["Пользователи"]
        Client["Клиент"]
        Seller["Продавец"]
    end

    subgraph system ["E-commerce Platform"]
        WebApp["Web Application<br/><i>Браузер пользователя</i>"]
        
        subgraph backend ["Backend"]
            API["API Gateway<br/><i>REST API</i><br/>Маршрутизация, <br/>аутентификация запросов"]
            
            subgraph modules ["Доменные модули"]
                Auth["Auth Module<br/><i>Аутентификация, авторизация,<br/>управление пользователями</i>"]
                Catalog["Catalog Module<br/><i>Товары, категории,<br/>поиск, фильтрация</i>"]
                Order["Order Module<br/><i>Корзина, заказы,<br/>управление статусами</i>"]
                PaymentSvc["Payment Module<br/><i>Интеграция с платежами</i>"]
                Notify["Notification Module<br/><i>Отправка email и SMS</i>"]
                Delivery["Delivery Module<br/><i>Интеграция с доставкой</i>"]
            end
        end
        
        subgraph data ["Хранилища"]
            DB[("Персистентное хранилище<br/><i>напр. PostgreSQL</i>")]
            Cache[("Кэш<br/><i>напр. Redis</i>")]
        end
    end

    subgraph external ["Внешние системы"]
        Payment["Платёжный провайдер"]
        ExtDelivery["Сервис доставки"]
        Email["Email-провайдер"]
        SMS["SMS-провайдер"]
        OAuth["OAuth-провайдеры"]
        FNS["API ФНС"]
    end

    Client --> WebApp
    Seller --> WebApp
    WebApp -->|"HTTPS/REST"| API
    
    API --> Auth
    API --> Catalog
    API --> Order
    
    Auth --> DB
    Auth --> Cache
    Auth -->|"OAuth 2.0"| OAuth
    Auth -->|"Запрос отправки кода"| Notify
    Auth -->|"Верификация продавцов"| FNS
    
    Catalog --> DB
    Catalog --> Cache
    
    Order --> DB
    Order -->|"Инициация платежа"| PaymentSvc
    Order -->|"Создание доставки"| Delivery
    Order -->|"Уведомление о статусе"| Notify
    
    PaymentSvc -->|"API платежей"| Payment
    
    Notify --> DB
    Notify -->|"Отправка email"| Email
    Notify -->|"Отправка SMS"| SMS
    
    Delivery -->|"API доставки"| ExtDelivery
    
    Payment -.->|"Webhook"| API
    ExtDelivery -.->|"Webhook"| API
```

### 3.2. Описание контейнеров

| Контейнер | Ответственность |
|-----------|-----------------|
| Web Application | Пользовательский интерфейс, работа в браузере |
| API Gateway | Единая точка входа, маршрутизация, JWT-валидация |
| Auth Module | Регистрация, вход (пароль, OAuth, SMS, email), JWT/сессии, роли, верификация продавцов через ФНС |
| Catalog Module | CRUD товаров, категории, полнотекстовый поиск, фильтрация |
| Order Module | Корзина, создание заказов, управление статусами заказа; интерфейс для продавца: подтверждение заказа, передача в доставку |
| Payment Module | Адаптер к внешним платёжным провайдерам, обработка платежей и возвратов |
| Notification Module | Единая точка отправки email/SMS, шаблонизация |
| Delivery Module | Адаптер к внешним API доставки, маппинг статусов |
| Персистентное хранилище | Хранение пользователей, товаров, заказов (например PostgreSQL) |
| Кэш | Кэш каталога, сессии (например Redis) |

---

## 4. Компоненты системы (C4 Level 3)

Детализация внутренней структуры ключевых контейнеров. Примеры особенно сложных систем

### 4.1. Диаграмма компонентов Order Module

```mermaid
flowchart TB
    subgraph OrderModule ["Order Module"]
        CartCtrl["CartController<br/><i>Корзина</i>"]
        BuyerOrderCtrl["BuyerOrderController<br/><i>Оформление заказа,<br/>просмотр своих заказов</i>"]
        SellerOrderCtrl["SellerOrderController<br/><i>Подтверждение заказа,<br/>передача в доставку</i>"]
        CartMgr["CartManager<br/><i>Бизнес-логика корзины</i>"]
        OrderMgr["OrderManager<br/><i>Создание и управление заказами</i>"]
        OrderRepo["OrderRepository<br/><i>Доступ к данным заказов</i>"]
    end

    API["API Gateway"] --> CartCtrl
    API --> BuyerOrderCtrl
    API --> SellerOrderCtrl
    CartCtrl --> CartMgr
    BuyerOrderCtrl --> OrderMgr
    SellerOrderCtrl --> OrderMgr
    CartMgr --> OrderRepo
    OrderMgr --> OrderRepo
    OrderRepo --> DB[("PostgreSQL")]
    OrderMgr --> PaymentCtrl["PaymentController"]
    OrderMgr --> NotifyCtrl["NotificationController"]
    OrderMgr --> DeliveryCtrl["DeliveryController"]
```

### 4.2. Диаграмма компонентов Catalog Module

```mermaid
flowchart TB
    subgraph CatalogModule ["Catalog Module"]
        CatalogCtrl["CatalogController<br/><i>Товары, категории, поиск</i>"]
        CatalogMgr["CatalogManager<br/><i>Бизнес-логика</i>"]
        CatalogRepo["CatalogRepository<br/><i>Доступ к данным</i>"]
    end

    API["API Gateway"] --> CatalogCtrl
    CatalogCtrl --> CatalogMgr
    CatalogMgr --> CatalogRepo
    CatalogRepo --> DB[("PostgreSQL")]
    CatalogMgr --> Cache[("Redis")]
```

### 4.3. Матрица зависимостей модулей

| Модуль ↓ зависит от -> | Auth | Catalog | Order | Payment | Notify | Delivery | Внешние системы |
|------------------------|:----:|:-------:|:-----:|:-------:|:------:|:--------:|-----------------|
| Auth Module | - | - | - | - | ✓ | - | OAuth, ФНС |
| Catalog Module | - | - | - | - | - | - | - |
| Order Module | - | - | - | ✓ | ✓ | ✓ | - |
| Payment Module | - | - | - | - | - | - | Платёжный провайдер |
| Notification Module | - | - | - | - | - | - | Email, SMS |
| Delivery Module | - | - | - | - | - | - | Сервис доставки |

Принципы зависимостей:

- Catalog Module не имеет внешних зависимостей
- Notification Module - единая точка для всех исходящих сообщений
- Payment Module и Delivery Module - адаптеры к внешним системам
- Order Module - координирует платёж, доставку, уведомления

---

## 5. Sequence Diagrams

### 5.1. Оформление заказа и оплата

```mermaid
sequenceDiagram
    autonumber
    actor Client as Клиент
    participant Web as Веб-приложение
    participant API as API Gateway
    participant Order as Order Module
    participant Auth as Auth Module
    participant Payment as Payment Module
    participant Pay as Платёжный провайдер
    participant Notify as Notification Module

    Client->>Web: Нажимает "Оформить заказ"
    Web->>API: Запрос на создание заказа
    API->>Auth: Проверка авторизации
    Auth-->>API: OK
    API->>Order: Создание заказа
    
    Order->>Order: Валидация корзины, резерв товаров
    Order->>Order: Статус -> AWAITING_PAYMENT
    Order->>Payment: Запрос на создание платежа
    Payment->>Pay: Создание платежа
    Pay-->>Payment: Ссылка на оплату
    Payment-->>Order: Ссылка на оплату
    Order-->>API: Данные заказа
    API-->>Web: Заказ создан
    Web->>Client: Редирект на страницу оплаты
    
    Client->>Pay: Оплачивает
    Pay->>API: Webhook: оплата успешна
    API->>Payment: Обработка webhook
    Payment->>Order: Уведомление об успешной оплате
    Order->>Order: Статус -> PAID (ожидает подтверждения)
    Order->>Notify: Уведомить продавца о новом заказе
    Order->>Notify: Уведомить клиента об успешной оплате
    Notify->>Notify: Отправка email + SMS
```

Дальнейшие шаги (подтверждение продавцом, передача в доставку) - см. раздел 5.3.

### 5.3. Подтверждение заказа продавцом и оформление отправления

```mermaid
sequenceDiagram
    autonumber
    actor Seller as Продавец
    participant Web as Веб-приложение
    participant API as API Gateway
    participant Order as Order Module
    participant Delivery as Delivery Module
    participant ExtDelivery as Сервис доставки
    participant Notify as Notification Module

    Note over Seller, Web: Шаг 1: Подтверждение заказа
    Seller->>Web: Открывает заказы (статус PAID)
    Web->>API: Запрос списка заказов
    Order-->>Web: Список оплаченных заказов

    Seller->>Web: Подтверждает заказ
    Web->>API: Запрос на подтверждение
    API->>Order: Подтверждение заказа
    Order->>Order: Статус -> PROCESSING
    Order->>Notify: Уведомить покупателя
    
    Note over Seller, Web: Шаг 2: Оформление отправления
    Seller->>Web: «Оформить отправление»
    Web->>API: Запрос на создание отправления
    API->>Order: Создание отправления
    Order->>Delivery: Запрос в службу доставки
    Delivery->>ExtDelivery: Создание заявки
    ExtDelivery-->>Delivery: Трек-номер + данные этикетки
    Delivery-->>Order: Трек-номер
    Order->>Order: Статус -> READY_TO_SHIP
    Order->>Notify: Уведомить покупателя (трек-номер)
    Order-->>Web: Этикетка для печати
    
    Seller->>Seller: Печатает этикетку, упаковывает
```

### 5.4. Приёмка посылки службой доставки и доставка

```mermaid
sequenceDiagram
    autonumber
    actor Seller as Продавец
    actor Buyer as Покупатель
    participant ExtDelivery as Сервис доставки
    participant API as API Gateway
    participant Delivery as Delivery Module
    participant Order as Order Module
    participant Notify as Notification Module

    Note over Seller, ExtDelivery: Шаг 3: Передача в СД
    Seller->>ExtDelivery: Приносит посылку в пункт приёма
    ExtDelivery->>ExtDelivery: Сканирует посылку
    ExtDelivery->>API: Webhook: посылка принята
    API->>Delivery: Обработка webhook
    Delivery->>Order: Обновление статуса
    Order->>Order: Статус -> SHIPPING
    Order->>Notify: Уведомить покупателя
    
    Note over ExtDelivery, Buyer: Шаг 4: Доставка
    ExtDelivery->>ExtDelivery: Доставка в пути...
    ExtDelivery->>Buyer: Вручение посылки
    ExtDelivery->>API: Webhook: доставлено
    API->>Delivery: Обработка webhook
    Delivery->>Order: Обновление статуса
    Order->>Order: Статус -> DELIVERED
    Order->>Notify: Уведомить покупателя
    
    Note over Buyer, Order: Шаг 5: Подтверждение получения
    alt Покупатель подтверждает
        Buyer->>API: Подтверждение получения
        API->>Order: Завершение заказа
        Order->>Order: Статус -> COMPLETED
    else Автоматически через N дней
        Order->>Order: Статус -> COMPLETED
    end
```

### 5.2. Вход по телефону (SMS-код)

```mermaid
sequenceDiagram
    autonumber
    actor User as Пользователь
    participant Web as Веб-приложение
    participant API as API Gateway
    participant Auth as Auth Module
    participant Notify as Notification Module
    participant SMS as SMS-провайдер

    User->>Web: Вводит номер телефона
    Web->>API: Запрос на отправку кода
    API->>Auth: Запрос авторизации по телефону
    Auth->>Auth: Генерация кода, сохранение в кэше
    Auth->>Notify: Запрос на отправку SMS
    Notify->>SMS: Отправка SMS
    SMS-->>Notify: OK
    Notify-->>Auth: OK
    Auth-->>API: Код отправлен
    API-->>Web: OK
    Web->>User: Показать поле для ввода кода

    User->>Web: Вводит код
    Web->>API: Запрос на проверку кода
    API->>Auth: Проверка кода
    Auth->>Auth: Валидация кода
    Auth->>Auth: Создание/получение пользователя, генерация токена
    Auth-->>API: Токены авторизации
    API-->>Web: Авторизация успешна
    Web->>User: Вход выполнен
```

---

## 6. Архитектурный стиль и решения

### 6.1. Выбор архитектурного стиля

Выбранный стиль: Модульный монолит с чётким разделением на доменные модули.

| Критерий | Модульный монолит | Микросервисы | Обоснование выбора |
|----------|-------------------|--------------|-------------------|
| Сложность разработки | Низкая | Высокая | Единая кодовая база, простой рефакторинг |
| Сложность развёртывания | Низкая | Высокая | Один артефакт, упрощённый CI/CD |
| Латентность между модулями | Наносекунды (in-process) | Миллисекунды (network) | Критично для checkout-процесса |
| Масштабирование | Вертикальное + горизонтальное (реплики) | Независимое по сервисам | Достаточно для начального этапа |
| Эволюция в микросервисы | Возможна | - | Модули можно выносить по мере роста |

Жертвуем независимым масштабированием отдельных функций ради простоты и скорости разработки на старте. Модульные границы позволят при необходимости вынести каталог или уведомления в отдельные микросервисы.

### 6.2. Архитектурный паттерн: Controller + Manager + Repository/Adapter

Внутри каждого модуля используется трёхслойная структура:

| Слой | Назначение | Примеры |
|------|------------|---------|
| Controller | Обработка HTTP-запросов, валидация входных данных, маршрутизация | OrderController, CatalogController |
| Manager | Бизнес-логика, оркестрация операций | OrderManager, CartManager |
| Repository / Adapter | Доступ к данным (Repository) или интеграция с внешними системами (Adapter) | OrderRepository, PaymentAdapter, EmailAdapter |

При межмодульном взаимодействии один модуль обращается к Controller другого модуля (а не напрямую к Manager), что обеспечивает чёткие границы и контракты между модулями.

### 6.3. Асинхронная обработка

Изначально система спроектирована с учётом асинхронной обработки операций, где это возможно:

- Отправка уведомлений (email, SMS) выполняется асинхронно
- Обработка webhook от платёжного провайдера и служб доставки
- Обновление статусов заказов

Это позволяет не блокировать пользовательские запросы и обеспечивает устойчивость при временной недоступности внешних сервисов.

### 6.4. Архитектурные решения (ADR)

#### ADR-001: Модульный монолит

| Аспект | Описание |
|--------|----------|
| Контекст | Нужна архитектура, которая позволит быстро развивать продукт на начальном этапе |
| Решение | Модульный монолит с чётким разделением на доменные модули |
| Альтернативы | Микросервисы с самого начала |
| Обоснование | Простота разработки и развёртывания; низкая латентность между модулями; модульные границы позволят при необходимости выделить микросервисы |
| Последствия | (+) Быстрый старт, единая кодовая база. (−) Вертикальное масштабирование, общий деплой |

#### ADR-002: Платежи через внешнего провайдера

| Аспект | Описание |
|--------|----------|
| Контекст | Необходимо принимать онлайн-платежи от клиентов |
| Решение | На начальном этапе - интеграция с внешним платёжным провайдером; данные карт не хранятся и не проходят через систему |
| Альтернативы | Собственный эквайринг с хранением карт (рассматривается как возможная эволюция) |
| Обоснование | PCI DSS compliance - дорого и сложно на старте; провайдеры берут ответственность на себя |
| Последствия | (+) Нет PCI DSS scope, меньше рисков, быстрый запуск. (−) Комиссия провайдера, зависимость от внешнего API. При росте объёмов возможен переход на собственную платёжную систему |

#### ADR-003: Единый Notification Module с отдельными адаптерами

| Аспект | Описание |
|--------|----------|
| Контекст | Несколько модулей должны отправлять уведомления (Auth - коды, Order - статусы) |
| Решение | Выделенный Notification Module как единая точка отправки с отдельными адаптерами для каждого канала (EmailAdapter, SMSAdapter) |
| Альтернативы | Каждый модуль обращается к email/SMS напрямую |
| Обоснование | Единообразие шаблонов, централизованный контроль; адаптеры позволяют легко менять провайдеров |
| Последствия | (+) Единая точка контроля, простая смена провайдера. (−) Дополнительная зависимость между модулями |

#### ADR-004: Кэш для сессий и часто запрашиваемых данных

| Аспект | Описание |
|--------|----------|
| Контекст | Нужен быстрый доступ к часто запрашиваемым данным (каталог) и хранение сессий |
| Решение | Выделенное in-memory хранилище (например Redis) для кэша каталога, сессий |
| Альтернативы | In-process cache |
| Обоснование | TTL, атомарные операции; снижение нагрузки на персистентное хранилище; работает при горизонтальном масштабировании |
| Последствия | (+) Снижение нагрузки на БД, быстрые сессии. (−) Дополнительный компонент инфраструктуры |

### 6.5. Эволюция архитектуры

При росте нагрузки и бизнеса возможны следующие шаги:

1. Load Balancer перед API Gateway - добавление балансировщика нагрузки для распределения запросов между репликами
2. Горизонтальное масштабирование - добавление реплик API и модулей за балансировщиком
3. Выделение любого модуля в отдельный микросервис - модульные границы позволяют при необходимости вынести Catalog, Notification или другой модуль в независимый микросервис
4. Собственная платёжная система - при достижении объёмов, когда экономия на комиссии провайдера превысит затраты на PCI DSS compliance и разработку, возможен переход на собственный эквайринг

---

## 7. Функциональные требования

### 7.1. Управление пользователями

- Регистрация клиента по email или телефону
- Регистрация продавца с указанием реквизитов
- Аутентификация: логин/пароль, OAuth, SMS-код, email magic link
- Управление профилем: контакты, адреса доставки
- Восстановление пароля через email

### 7.2. Каталог и поиск

- Просмотр каталога по категориям
- Полнотекстовый поиск товаров
- Фильтрация по цене, наличию, характеристикам
- Карточка товара: описание, фото, цена, наличие

### 7.3. Заказы и оплата

- Добавление товаров в корзину
- Оформление заказа с выбором адреса и службы доставки (из разрешённых продавцом)
- Онлайн-оплата через платёжного провайдера
- Просмотр истории заказов и текущего статуса
- Отмена заказа (до отправки в СД)
- Подтверждение получения заказа покупателем

### 7.4. Доставка и уведомления

- Выбор службы доставки из списка, разрешённого продавцом
- Отслеживание статуса доставки (трекинг)
- Автоматическое обновление статусов по webhook от службы доставки
- Уведомления о статусе заказа по email и SMS
- Автоматическое завершение заказа через N дней после доставки

### 7.5. Функции продавца

- Верификация юридических реквизитов через API ФНС
- Настройка разрешённых служб доставки для своих товаров
- Добавление и редактирование товаров
- Управление ценами и остатками
- Просмотр аналитики: продажи, остатки, популярные товары
- Просмотр заказов по своим товарам и их статусов
- Подтверждение заказа после проверки наличия
- Оформление отправления: получение трек-номера и этикетки для печати
- Отмена заказа (до передачи в СД)

## 8. Нефункциональные требования

### 8.1 Требования к производительности

- Время отклика системы на поисковый запрос пользователя не должно превышать 2 секунд при средней нагрузке.
- Время загрузки карточки товара не должно превышать 1 секунды в 95% запросов.
- Система должна обрабатывать одновременно не менее 10 000 одновременных пользователей без деградации производительности.

### 8.2 Требования к надежности

- Пользователю, работающему через браузер должен быть предоставлен непрерывный доступ к веб-сайту, расположенному по определенному url-адресу
- Исключен отказ работы веб-сайта и мобильного приложения из-за некорректных действий клиента
- Исключена возможность непреднамеренного завершения работы программных компонент во всех случаях, кроме технических проблем на стороне провайдера серверов
- Веб-сайт и мобильное приложение должны обеспечивать доступность для пользователя не менее 98% времени в месяц

### 8.3 Требования к безопасности

- Платёжные операции безопасны: используется шифрование, хранение данных и обработка платежей осуществляется только через платёжного провайдера.
- Система защищена от основных видов атак Пароли хранятся в зашифрованном виде

### 8.4. Требования к поддерживаемости и расширяемости

- Архитектура системы должна обеспечивать возможность расширения функциональности без значительных изменений существующего кода
- Добавление новых платёжных и логистических провайдеров должно выполняться без изменения бизнес-логики системы
